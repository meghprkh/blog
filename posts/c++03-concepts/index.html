<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Concepts in C++03</title><link rel=stylesheet href=../../css/style.css></head><body><header class=site-header><h1>Megh's Blog</h1><nav><ul><li><a href=../../>Home</a></li><li><a href=../../categories>Categories</a></li><li><a href=../../tags>Tags</a></li><li><a href=../../about>About</a></li><li><a href=../../index.xml>Feed</a></li></ul></nav></header><main><article class=post><h1 class=title>Concepts in C++03</h1><div class=article-details><time>Thu Aug 4 2022</time>
in
<a href=../../categories/c++>C++</a></div><div><nav id=TableOfContents><ul><li><a href=#what-are-c-concepts>What are C++ Concepts</a></li><li><a href=#c03-concepts>C++03 Concepts</a></li><li><a href=#rant-on-c20-concepts>Rant on C++20 Concepts</a></li><li><a href=#summary>Summary</a></li></ul></nav><p>C++20 Concepts are a new language feature that ease generic programming, but are primarily syntactic sugar.</p><p>We will try to implement them in C++03, with one caveat - we must explicitly specify that it implements the concept.</p><p>NOTE: We do not need to be able to modify the class for this.</p><h2 id=what-are-c-concepts>What are C++ Concepts</h2><p>C++ Concepts allow us to do compile-time dispatch of methods. Kind of like Rust traits.</p><div class=code-play-button><a href=https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiLXN0ZD1jKysyMCJ9XSwiZXhlY3V0b3JzIjpbeyJjb21waWxlciI6eyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiLXN0ZD1jKysyMCJ9fV0sImlkIjoxLCJsYW5ndWFnZSI6ImMrKyIsInNvdXJjZSI6IiNpbmNsdWRlIFx1MDAzY2lvc3RyZWFtXHUwMDNlXG4jaW5jbHVkZSBcdTAwM2Njb25jZXB0c1x1MDAzZVxuXG4vLyBEZWZpbmUgdGhlIGNvbmNlcHQgY2hlY2tcbnRlbXBsYXRlIFx1MDAzY2NsYXNzIFRcdTAwM2VcbmNvbmNlcHQgQ291bnRlciA9IHJlcXVpcmVzKFQgY291bnRlciwgaW50IG5ld19jb3VudCkge1xuICAgIHsgY291bnRlci5nZXRfY291bnQoKSB9IC1cdTAwM2Ugc3RkOjpzYW1lX2FzXHUwMDNjaW50XHUwMDNlO1xuICAgIHsgY291bnRlci5zZXRfY291bnQobmV3X2NvdW50KSB9IC1cdTAwM2Ugc3RkOjpzYW1lX2FzXHUwMDNjdm9pZFx1MDAzZTtcbiAgICB7IFQ6Om1heF9jb3VudCgpIH0gLVx1MDAzZSBzdGQ6OnNhbWVfYXNcdTAwM2NpbnRcdTAwM2U7XG59O1xuXG4vLyBPdXIgc3RydWN0XG5zdHJ1Y3QgTXlDb3VudGVyIHtcbiAgICBpbnQgY291bnQ7XG5cbiAgICBpbnQgZ2V0X2NvdW50KCkgeyByZXR1cm4gY291bnQ7IH1cbiAgICB2b2lkIHNldF9jb3VudChpbnQgbmV3X2NvdW50KSB7IGNvdW50ID0gbmV3X2NvdW50OyB9XG4gICAgc3RhdGljIGludCBtYXhfY291bnQoKSB7IHJldHVybiAxMDA7IH1cbn07XG5cbi8vIEV4YW1wbGUgdXNhZ2VcbnRlbXBsYXRlIFx1MDAzY3R5cGVuYW1lIFRcdTAwM2VcbnJlcXVpcmVzIENvdW50ZXJcdTAwM2NUXHUwMDNlXG52b2lkIHByaW50X2NvdW50ZXIoVFx1MDAyNiBjb3VudGVyKSB7XG4gICAgLy8gQ2FuIGFsc28gdXNlIHNob3J0aGFuZCBgdGVtcGxhdGUgXHUwMDNjQ291bnRlciBUXHUwMDNlYCBpbnN0ZWFkIG9mIGByZXF1aXJlc2AgY2xhdXNlXG4gICAgc3RkOjpjb3V0IFx1MDAzY1x1MDAzYyBcIkNvdW50ZXIgd2l0aCBjb3VudCBcIiBcdTAwM2NcdTAwM2MgY291bnRlci5nZXRfY291bnQoKSBcdTAwM2NcdTAwM2Mgc3RkOjplbmRsO1xufVxuXG5pbnQgbWFpbigpIHtcbiAgICBNeUNvdW50ZXIgYyB7IDI1IH07XG4gICAgcHJpbnRfY291bnRlcihjKTtcbn0ifV19 target=_blank>&#9654;</a></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// Define the concept check
</span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>T</span><span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>concept</span> Counter <span style=color:#f92672>=</span> <span style=color:#66d9ef>requires</span>(T counter, <span style=color:#66d9ef>int</span> new_count) {
    { counter.get_count() } <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>same_as<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span>;
    { counter.set_count(new_count) } <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>same_as<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span>;
    { T<span style=color:#f92672>::</span>max_count() } <span style=color:#f92672>-&gt;</span> std<span style=color:#f92672>::</span>same_as<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>int</span><span style=color:#f92672>&gt;</span>;
};

<span style=color:#75715e>// Our struct
</span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MyCounter</span> {
    <span style=color:#66d9ef>int</span> count;

    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_count</span>() { <span style=color:#66d9ef>return</span> count; }
    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_count</span>(<span style=color:#66d9ef>int</span> new_count) { count <span style=color:#f92672>=</span> new_count; }
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>max_count</span>() { <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>100</span>; }
};

<span style=color:#75715e>// Example usage
</span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>requires</span> Counter<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>void</span> print_counter(T<span style=color:#f92672>&amp;</span> counter) {
    <span style=color:#75715e>// Can also use shorthand `template &lt;Counter T&gt;` instead of `requires` clause
</span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Counter with count &#34;</span> <span style=color:#f92672>&lt;&lt;</span> counter.get_count() <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
}

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
    MyCounter c { <span style=color:#ae81ff>25</span> };
    print_counter(c);
}
</code></pre></div><p>Notice that we never needed to specify that <code>MyCounter</code> implements <code>Counter</code>. This can easily be fixed by requiring some constant to be defined in <code>MyCounter</code> or otherwise.</p><p>We call the above &ldquo;implicit concepts&rdquo;. We will try to implement &ldquo;explicit concepts&rdquo; - where something must specify that the concept has been implemented.</p><h2 id=c03-concepts>C++03 Concepts</h2><p>We will use C++11 for a better STL, but we can easily swap it Boost</p><div class=code-play-button><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiLXN0ZD1jKysxMSJ9XSwiZXhlY3V0b3JzIjpbeyJjb21waWxlciI6eyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiLXN0ZD1jKysxMSJ9fV0sImlkIjoxLCJsYW5ndWFnZSI6ImMrKyIsInNvdXJjZSI6IiNpbmNsdWRlIFx1MDAzY2lvc3RyZWFtXHUwMDNlXG4jaW5jbHVkZSBcdTAwM2N0eXBlX3RyYWl0c1x1MDAzZVxuXG4vLyBEZWZpbmUgdGhlIGNvbmNlcHRcbnN0cnVjdCBDb3VudGVyIHtcbiAgICB0ZW1wbGF0ZSBcdTAwM2N0eXBlbmFtZSBUXHUwMDNlXG4gICAgc3RydWN0IGltcGxlbWVudGVkX2J5OiBzdGQ6OmZhbHNlX3R5cGUge307XG5cbiAgICAvLyBEZWZpbmUgdGhlIGNoZWNrXG4gICAgdGVtcGxhdGUgXHUwMDNjdHlwZW5hbWUgVFx1MDAzZVxuICAgIHN0cnVjdCBjaGVjazogc3RkOjp0cnVlX3R5cGUge1xuICAgICAgICBzdGF0aWNfYXNzZXJ0KHN0YXRpY19jYXN0XHUwMDNjIGludCAoVDo6KikoKSBcdTAwM2UoXHUwMDI2VDo6Z2V0X2NvdW50KSk7XG4gICAgICAgIHN0YXRpY19hc3NlcnQoc3RhdGljX2Nhc3RcdTAwM2Mgdm9pZCAoVDo6KikoaW50KSBcdTAwM2UoXHUwMDI2VDo6c2V0X2NvdW50KSk7XG4gICAgICAgIHN0YXRpY19hc3NlcnQoc3RhdGljX2Nhc3RcdTAwM2MgaW50ICgqKSgpIFx1MDAzZShcdTAwMjZUOjptYXhfY291bnQpKTtcbiAgICB9O1xufTtcblxuLy8gRGVmaW5lIG91ciBzdHJ1Y3Qgbm9ybWFsbHksIHdpdGhvdXQgYW55IG1vZGlmaWNhdGlvbnNcbnN0cnVjdCBNeUNvdW50ZXIge1xuICAgIGludCBjb3VudDtcblxuICAgIGludCBnZXRfY291bnQoKSB7IHJldHVybiBjb3VudDsgfVxuICAgIHZvaWQgc2V0X2NvdW50KGludCBuZXdfY291bnQpIHsgY291bnQgPSBuZXdfY291bnQ7IH1cbiAgICBzdGF0aWMgaW50IG1heF9jb3VudCgpIHsgcmV0dXJuIDEwMDsgfVxufTtcbi8vIERlY2xhcmUgYW5kIGNoZWNrIHRoYXQgd2UgaGF2ZSBpbXBsZW1lbnRlZCB0aGUgdHJhaXRcbnRlbXBsYXRlXHUwMDNjXHUwMDNlXG5zdHJ1Y3QgQ291bnRlcjo6aW1wbGVtZW50ZWRfYnlcdTAwM2NNeUNvdW50ZXJcdTAwM2U6IENvdW50ZXI6OmNoZWNrXHUwMDNjTXlDb3VudGVyXHUwMDNlIHt9O1xuXG4vLyBFeGFtcGxlIHVzYWdlIHVzaW5nIGNsYXNzaWMgZW5hYmxlX2lmIFNGSU5BRS4gVmVyYm9zZSB5ZXQgY29udmVudGlvbmFsXG50ZW1wbGF0ZSBcdTAwM2N0eXBlbmFtZSBUXHUwMDNlXG50eXBlbmFtZSBzdGQ6OmVuYWJsZV9pZlx1MDAzY1xuICAgIENvdW50ZXI6OmltcGxlbWVudGVkX2J5XHUwMDNjVFx1MDAzZTo6dmFsdWUsXG52b2lkIFx1MDAzZTo6dHlwZVxucHJpbnRfY291bnRlcihUXHUwMDI2IGNvdW50ZXIpIHtcbiAgICBzdGQ6OmNvdXQgXHUwMDNjXHUwMDNjIFwiQ291bnRlciB3aXRoIGNvdW50IFwiIFx1MDAzY1x1MDAzYyBjb3VudGVyLmdldF9jb3VudCgpIFx1MDAzY1x1MDAzYyBzdGQ6OmVuZGw7XG59XG5cbmludCBtYWluKCkge1xuICAgIE15Q291bnRlciBjb3VudGVyIHsgMyB9O1xuICAgIHByaW50X2NvdW50ZXIoY291bnRlcik7XG59In1dfQ==" target=_blank>&#9654;</a></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// Define the concept
</span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Counter</span> {
    <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>implemented_by</span><span style=color:#f92672>:</span> std<span style=color:#f92672>::</span>false_type {};

    <span style=color:#75715e>// Define the check
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>check</span><span style=color:#f92672>:</span> std<span style=color:#f92672>::</span>true_type {
        <span style=color:#66d9ef>static_assert</span>(<span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>int</span> (T<span style=color:#f92672>::*</span>)() <span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span>T<span style=color:#f92672>::</span>get_count));
        <span style=color:#66d9ef>static_assert</span>(<span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>void</span> (T<span style=color:#f92672>::*</span>)(<span style=color:#66d9ef>int</span>) <span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span>T<span style=color:#f92672>::</span>set_count));
        <span style=color:#66d9ef>static_assert</span>(<span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>int</span> (<span style=color:#f92672>*</span>)() <span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span>T<span style=color:#f92672>::</span>max_count));
    };
};

<span style=color:#75715e>// Define our struct normally, without any modifications
</span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MyCounter</span> {
    <span style=color:#66d9ef>int</span> count;

    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_count</span>() { <span style=color:#66d9ef>return</span> count; }
    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_count</span>(<span style=color:#66d9ef>int</span> new_count) { count <span style=color:#f92672>=</span> new_count; }
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>max_count</span>() { <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>100</span>; }
};
<span style=color:#75715e>// Declare and check that we have implemented the trait
</span><span style=color:#75715e></span><span style=color:#66d9ef>template</span><span style=color:#f92672>&lt;&gt;</span>
<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Counter</span><span style=color:#f92672>::</span>implemented_by<span style=color:#f92672>&lt;</span>MyCounter<span style=color:#f92672>&gt;:</span> Counter<span style=color:#f92672>::</span>check<span style=color:#f92672>&lt;</span>MyCounter<span style=color:#f92672>&gt;</span> {};

<span style=color:#75715e>// Example usage using classic enable_if SFINAE. Verbose yet conventional
</span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
<span style=color:#66d9ef>typename</span> std<span style=color:#f92672>::</span>enable_if<span style=color:#f92672>&lt;</span>
    Counter<span style=color:#f92672>::</span>implemented_by<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;::</span>value,
<span style=color:#66d9ef>void</span> <span style=color:#f92672>&gt;::</span>type
print_counter(T<span style=color:#f92672>&amp;</span> counter) {
    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Counter with count &#34;</span> <span style=color:#f92672>&lt;&lt;</span> counter.get_count() <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
}

<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
    MyCounter counter { <span style=color:#ae81ff>3</span> };
    print_counter(counter);
}
</code></pre></div><p>To do this in C++03, lets sprinkle some macros. We will also <em>beautify</em> the C++11 code using macros.</p><div class=code-play-button><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiLXN0ZD1jKyswMyJ9XSwiZXhlY3V0b3JzIjpbeyJjb21waWxlciI6eyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiLXN0ZD1jKyswMyJ9fV0sImlkIjoxLCJsYW5ndWFnZSI6ImMrKyIsInNvdXJjZSI6IiNpbmNsdWRlIFx1MDAzY2lvc3RyZWFtXHUwMDNlXG5cbiNpZiBfX2NwbHVzcGx1cyAhPSAxOTk3MTFMXG4jaW5jbHVkZSBcdTAwM2N0eXBlX3RyYWl0c1x1MDAzZVxuI2Vsc2Vcbi8vIE1vbmtleSBwYXRjaCBzdGQgZm9yIHRoZSBzYWtlIG9mIHRoZSBleGFtcGxlXG4vLyBDYW4gdXNlIHlvdXIgZmF2b3VyaXRlIHV0aWxpdHkgbGlicmFyeSBpbnN0ZWFkXG5uYW1lc3BhY2Ugc3RkIHtcbiAgICBzdHJ1Y3QgdHJ1ZV90eXBlIHsgc3RhdGljIGNvbnN0IGJvb2wgdmFsdWUgPSB0cnVlOyB9O1xuICAgIHN0cnVjdCBmYWxzZV90eXBlIHsgc3RhdGljIGNvbnN0IGJvb2wgdmFsdWUgPSB0cnVlOyB9O1xuICAgIHRlbXBsYXRlIFx1MDAzY2Jvb2wgQ29uZCwgdHlwZW5hbWUgVHlwZSA9IHZvaWRcdTAwM2VcbiAgICBzdHJ1Y3QgZW5hYmxlX2lmIHsgdHlwZWRlZiBUeXBlIHR5cGU7IH07XG4gICAgdGVtcGxhdGUgXHUwMDNjdHlwZW5hbWUgVHlwZVx1MDAzZVxuICAgIHN0cnVjdCBlbmFibGVfaWZcdTAwM2NmYWxzZSwgVHlwZVx1MDAzZSB7IH07XG59XG4jZW5kaWZcblxuI2RlZmluZSBfQ09OQ0VQVF9UT0tFTlBBU1RFKHgsIHkpIHggIyMgeVxuI2RlZmluZSBfQ09OQ0VQVF9UT0tFTlBBU1RFMih4LCB5KSBfQ09OQ0VQVF9UT0tFTlBBU1RFKHgsIHkpXG5cbiNpZiBfX2NwbHVzcGx1cyAhPSAxOTk3MTFMXG5cbiNkZWZpbmUgQ09OQ0VQVF9DSEVDS19TVEFSVCBcXFxuICAgIHRlbXBsYXRlIFx1MDAzY3R5cGVuYW1lIFNlbGZcdTAwM2UgXFxcbiAgICBzdHJ1Y3QgY2hlY2s6IHN0ZDo6dHJ1ZV90eXBlIHsgXFxcblxuI2RlZmluZSBDT05DRVBUX0NIRUNLX0VORCB9O1xuXG4jZGVmaW5lIENPTkNFUFRfQVNTRVJUIHN0YXRpY19hc3NlcnRcblxuI2RlZmluZSBJTVBMX0NPTkNFUFQoQ09OQ0VQVCwgQ0xTKSBcXFxuICAgIHRlbXBsYXRlXHUwMDNjXHUwMDNlIFxcXG4gICAgc3RydWN0IENPTkNFUFQ6OmltcGxlbWVudGVkX2J5XHUwMDNjQ0xTXHUwMDNlOiBDT05DRVBUOjpjaGVja1x1MDAzY0NMU1x1MDAzZSB7fTsgXFxcblxuI2Vsc2VcblxuLy8gSW4gQysrMDMgd2UgZG9udCBoYXZlIHN0YXRpY19hc3NlcnQgYW5kIHdlIGNhbm5vdCB1c2UgXCJcdTAwMjZUOjptZXRob2RcIlxuLy8gaW5zaWRlIHNheSBhIEJPT1NUX1NUQVRJQ19BU1NFUlQuXG4vLyBXZSBqdXN0IGRlZmluZSBhbGwgb2YgdGhlIGNoZWNrcyBpbnNpZGUgdGhlIGNvbnN0cnVjdG9yIG9mIGBjaGVja2AuXG4vLyBUaGVuIGluIGBJTVBMX0NPTkNFUFRgIHdlIGluc3RhbnRpYXRlIGEgc3RhdGljIG9iamVjdCBvZiB0aGUgc2FtZS5cblxuI2RlZmluZSBDT05DRVBUX0NIRUNLX1NUQVJUIFxcXG4gICAgdGVtcGxhdGUgXHUwMDNjdHlwZW5hbWUgU2VsZlx1MDAzZSBcXFxuICAgIHN0cnVjdCBjaGVjazogc3RkOjp0cnVlX3R5cGUgeyBcXFxuICAgICAgICBjaGVjaygpIHsgXFxcblxuI2RlZmluZSBDT05DRVBUX0NIRUNLX0VORCB9IH07XG5cbiNkZWZpbmUgQ09OQ0VQVF9BU1NFUlRcblxuI2RlZmluZSBJTVBMX0NPTkNFUFQoQ09OQ0VQVCwgQ0xTKSBcXFxuICAgIHRlbXBsYXRlXHUwMDNjXHUwMDNlIFxcXG4gICAgc3RydWN0IENPTkNFUFQ6OmltcGxlbWVudGVkX2J5XHUwMDNjQ0xTXHUwMDNlOiBDT05DRVBUOjpjaGVja1x1MDAzY0NMU1x1MDAzZSB7fTsgXFxcbiAgICBzdGF0aWMgQ09OQ0VQVDo6Y2hlY2tcdTAwM2NDTFNcdTAwM2UgX0NPTkNFUFRfVE9LRU5QQVNURTIoX2NvbmNlcHRfY2hlY2tfLCBfX0xJTkVfXyk7IFxcXG5cbiNlbmRpZlxuXG4vLyBEZWZpbmUgdGhlIGNvbmNlcHRcbnN0cnVjdCBDb3VudGVyIHtcbiAgICB0ZW1wbGF0ZSBcdTAwM2N0eXBlbmFtZSBUXHUwMDNlXG4gICAgc3RydWN0IGltcGxlbWVudGVkX2J5OiBzdGQ6OmZhbHNlX3R5cGUge307XG5cbiAgICAvLyBEZWZpbmUgdGhlIGNoZWNrXG4gICAgQ09OQ0VQVF9DSEVDS19TVEFSVFxuICAgICAgICBDT05DRVBUX0FTU0VSVChzdGF0aWNfY2FzdFx1MDAzYyBpbnQgKFNlbGY6OiopKCkgXHUwMDNlKFx1MDAyNlNlbGY6OmdldF9jb3VudCkpO1xuICAgICAgICBDT05DRVBUX0FTU0VSVChzdGF0aWNfY2FzdFx1MDAzYyB2b2lkIChTZWxmOjoqKShpbnQpIFx1MDAzZShcdTAwMjZTZWxmOjpzZXRfY291bnQpKTtcbiAgICAgICAgQ09OQ0VQVF9BU1NFUlQoc3RhdGljX2Nhc3RcdTAwM2MgaW50ICgqKSgpIFx1MDAzZShcdTAwMjZTZWxmOjptYXhfY291bnQpKTtcbiAgICBDT05DRVBUX0NIRUNLX0VORFxufTtcblxuLy8gRGVmaW5lIG91ciBzdHJ1Y3RcbnN0cnVjdCBNeUNvdW50ZXIge1xuICAgIGludCBjb3VudDtcblxuICAgIGludCBnZXRfY291bnQoKSB7IHJldHVybiBjb3VudDsgfVxuICAgIHZvaWQgc2V0X2NvdW50KGludCBuZXdfY291bnQpIHsgY291bnQgPSBuZXdfY291bnQ7IH1cbiAgICBzdGF0aWMgaW50IG1heF9jb3VudCgpIHsgcmV0dXJuIDEwMDsgfVxufTtcbi8vIC4uLiBza2lwcGluZyBkZWZpbml0aW9uIG9mIHN0cnVjdCBNeUNvdW50ZXIgLi4uXG4vLyBEZWNsYXJlIGFuZCBjaGVjayB0aGF0IHdlIGhhdmUgaW1wbGVtZW50ZWQgdGhlIHRyYWl0XG5JTVBMX0NPTkNFUFQoQ291bnRlciwgTXlDb3VudGVyKTtcblxuLy8gRXhhbXBsZSB1c2FnZSB1c2luZyBjbGFzc2ljIGVuYWJsZV9pZiBTRklOQUVcbnRlbXBsYXRlIFx1MDAzY3R5cGVuYW1lIFRcdTAwM2VcbnR5cGVuYW1lIHN0ZDo6ZW5hYmxlX2lmXHUwMDNjXG4gICAgQ291bnRlcjo6aW1wbGVtZW50ZWRfYnlcdTAwM2NUXHUwMDNlOjp2YWx1ZSxcbnZvaWQgXHUwMDNlOjp0eXBlXG5wcmludF9jb3VudGVyKFRcdTAwMjYgY291bnRlcikge1xuICAgIHN0ZDo6Y291dCBcdTAwM2NcdTAwM2MgXCJDb3VudGVyIHdpdGggY291bnQgXCIgXHUwMDNjXHUwMDNjIGNvdW50ZXIuZ2V0X2NvdW50KCkgXHUwMDNjXHUwMDNjIHN0ZDo6ZW5kbDtcbn1cblxuaW50IG1haW4oKSB7XG4gICAgTXlDb3VudGVyIGNvdW50ZXI7XG4gICAgY291bnRlci5jb3VudCA9IDM7XG4gICAgQ291bnRlcjo6Y2hlY2tcdTAwM2NNeUNvdW50ZXJcdTAwM2UgeDtcbiAgICBwcmludF9jb3VudGVyKGNvdW50ZXIpO1xufSJ9XX0=" target=_blank>&#9654;</a></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// Define the concept
</span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Counter</span> {
    <span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
    <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>implemented_by</span><span style=color:#f92672>:</span> std<span style=color:#f92672>::</span>false_type {};

    <span style=color:#75715e>// Define the check
</span><span style=color:#75715e></span>    CONCEPT_CHECK_START
        <span style=color:#a6e22e>CONCEPT_ASSERT</span>(<span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>int</span> (Self<span style=color:#f92672>::*</span>)() <span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span>Self<span style=color:#f92672>::</span>get_count));
        CONCEPT_ASSERT(<span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>void</span> (Self<span style=color:#f92672>::*</span>)(<span style=color:#66d9ef>int</span>) <span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span>Self<span style=color:#f92672>::</span>set_count));
        CONCEPT_ASSERT(<span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>int</span> (<span style=color:#f92672>*</span>)() <span style=color:#f92672>&gt;</span>(<span style=color:#f92672>&amp;</span>Self<span style=color:#f92672>::</span>max_count));
    CONCEPT_CHECK_END
};
<span style=color:#75715e>// ... skipping definition of struct MyCounter ...
</span><span style=color:#75715e>// Declare and check that we have implemented the trait
</span><span style=color:#75715e></span>IMPL_CONCEPT(Counter, MyCounter);
</code></pre></div><p>We can now use this for defining <code>print_count</code> using the same <code>enable_if</code> way we used this previously. Also most of our macros are simple ones that dont require any parenthesis-escaping except <code>IMPL_CONCEPT</code>.</p><h2 id=rant-on-c20-concepts>Rant on C++20 Concepts</h2><p>C++20 Concepts thus allow for powerful implicit matching. But, let us take the following example:</p><blockquote><p>Lets say we are building some kind of social media stats app and we have <code>youtube_api::VideoViewCounter</code> and <code>instagram_api::LikeCounter</code>. Both of them have the <code>get_count</code> method.</p><p>We want to define a <code>print_count(counter)</code> method which takes either of these two classes and does <code>std::cout &lt;&lt; counter.get_count()</code>.</p></blockquote><p>We do not have control over either APIs, but would like a common abstraction. We have two choices:</p><ol><li>Declare an &ldquo;implicit concept&rdquo; called <code>Counter</code> which requires a <code>get_count</code> method. Define templated <code>print_count</code> for concept</li><li>Declare an &ldquo;explicit concept&rdquo; with the same. Specify that the above two classes implement this concept without modying the classes. Define templated <code>print_count</code> for concept.</li><li>Use an unchecked templated <code>print_count</code></li></ol><p>Now consider the following modification to the codebase:</p><blockquote><p>We add class <code>my_shared_ptr</code> which has <code>get_count</code> method which returns the reference count of the pointer.</p><p>Lets say another engineer started refactoring to store the objects in <code>shared_ptr</code> but <code>print_counter</code> has not been modified for an explicit overload for <code>shared_ptr</code></p><p>What happens when we call <code>print_count(counter_ptr)</code> with <code>counter_ptr = my_shared_ptr&lt;youtube_api::VideoViewCounter>()</code>?</p></blockquote><p>In the case of &ldquo;implicit concepts&rdquo;, we would see the reference count being printed, without any compile or run-time error.</p><p>In the case of &ldquo;explicit concepts&rdquo;, we would get a compile time error since no method matches this.</p><p>In the case of an unchecked template too, we would see the reference count being printed..</p><p>Thus, <em>implicit concepts are almost as bad as not having any check at all</em>. Except maybe they can produce neater compiler errors (ignoring the case of overloading based on concepts).</p><p>And if explicit concepts are better and already implementable in C++03, why provide an abstraction where most developers will write error-prone code instead of providing syntax sugar for explicit concepts?</p><h2 id=summary>Summary</h2><p>We saw what C++ concepts were and how to write &ldquo;explicit concepts&rdquo; in C++03. This was followed by a small rant on C++20 implicit concepts.</p><p>In the next post I will describe how this compares to Rust traits and how to implement &ldquo;trait objects&rdquo; or &ldquo;concept maps&rdquo; using the same code.</p></div><div class=tags>[ Tags:
<a href=../../tags/c++>#C++</a>
<a href=../../tags/rust>#Rust</a>
<a href=../../tags/series-btrait-intro>#series-btrait-intro</a>
]</div></article><script src=https://utteranc.es/client.js repo=meghprkh/blog issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script></main><footer><p>&copy; 2022 <a href=http://meghprkh.github.io/blog/>Megh's Blog</a></p></footer><script src=../../js/theme.js></script></body></html>