<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>C++ Force Inline</title><link rel=stylesheet href=../../css/style.css></head><body><header class=site-header><h1>Megh's Blog</h1><nav><ul><li><a href=../../>Home</a></li><li><a href=../../categories>Categories</a></li><li><a href=../../tags>Tags</a></li><li><a href=../../about>About</a></li><li><a href=../../index.xml>Feed</a></li></ul></nav></header><main><article class=post><h1 class=title>C++ Force Inline</h1><div class=article-details><time>Sun Sep 4 2022</time></div><div><p>Function calls are expensive. They require allocating a new stack frame, pushing params calling, return values. And lets not get started on calling conventions. <code>inline</code>, <code>always_inline</code> and <code>forceinline</code> are just hints. They dont always inline <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>Trust the compiler some say. Profile your code say the others. Use macros say the old and wise.</p><p>But what if you are developing a library and need to ensure that your method gets inlined? You cant say trust the compiler, because the users want to trust your library. You cant profile the code, because the application isn&rsquo;t your code.</p><p>We want a <code>FORCE_INLINE</code> keyword that <em>just works</em>, at least on the three major compilers - <code>g++</code>, <code>clang</code> and <code>msvc</code>. If it cant inline, it should error in a meaningful way.</p><p>The examples:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>decrement</span>(<span style=color:#66d9ef>int</span> x) { <span style=color:#66d9ef>return</span> x <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; }
<span style=color:#66d9ef>int</span> <span style=color:#a6e22e>factorial</span>(<span style=color:#66d9ef>int</span> x) { <span style=color:#66d9ef>return</span> (x <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>?</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>:</span> x <span style=color:#f92672>*</span> factorial(x <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>); }
</code></pre></div><p>Putting our <code>FORCE_INLINE</code> keyword in front of <code>decrement</code> should inline.</p><p>It should either compile-time error or link-time error if put it in front of <code>factorial</code> (as the recursion depth / input argument is not known at compile-time).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>#if defined(__clang__)
#define FORCE_INLINE [[gnu::always_inline]] [[gnu::gnu_inline]] extern inline

#elif defined(__GNUC__)
#define FORCE_INLINE [[gnu::always_inline]] inline

#elif defined(_MSC_VER)
#pragma warning(error: 4714)
#define FORCE_INLINE __forceinline

#else
#error Unsupported compiler
#endif
</code></pre></div><p>Now lets check it in action:</p><table><thead><tr><th style=text-align:left>Compiler</th><th style=text-align:left>Working case</th><th style=text-align:left>Error case</th><th style=text-align:left>Error type</th></tr></thead><tbody><tr><td style=text-align:left>Clang</td><td style=text-align:left><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImNsYW5nMTQwMCIsIm9wdGlvbnMiOiIifV0sImV4ZWN1dG9ycyI6W3siYXJndW1lbnRzIjoiYSBiIGMgZCBlIiwiY29tcGlsZXIiOnsiaWQiOiJjbGFuZzE0MDAiLCJvcHRpb25zIjoiIn0sImNvbXBpbGVyT3V0cHV0VmlzaWJsZSI6InRydWUifV0sImlkIjoxLCJsYW5ndWFnZSI6ImMrKyIsInNvdXJjZSI6IiNpZiBkZWZpbmVkKF9fY2xhbmdfXylcbiNkZWZpbmUgRk9SQ0VfSU5MSU5FIFtbZ251OjphbHdheXNfaW5saW5lXV0gW1tnbnU6OmdudV9pbmxpbmVdXSBleHRlcm4gaW5saW5lXG4jZWxpZiBkZWZpbmVkKF9fR05VQ19fKVxuI2RlZmluZSBGT1JDRV9JTkxJTkUgW1tnbnU6OmFsd2F5c19pbmxpbmVdXSBpbmxpbmVcbiNlbGlmIGRlZmluZWQoX01TQ19WRVIpXG4jcHJhZ21hIHdhcm5pbmcoZXJyb3I6IDQ3MTQpXG4jZGVmaW5lIEZPUkNFX0lOTElORSBfX2ZvcmNlaW5saW5lXG4jZWxzZVxuI2Vycm9yIFVuc3VwcG9ydGVkIGNvbXBpbGVyXG4jZW5kaWZcblxuRk9SQ0VfSU5MSU5FIGludCBkZWNyZW1lbnQoaW50IHgpIHsgcmV0dXJuIHggLSAxOyB9XG5pbnQgZmFjdG9yaWFsKGludCB4KSB7IHJldHVybiAoeCA9PSAwKSA%2FIDEgOiB4ICogZmFjdG9yaWFsKHggLSAxKTsgfVxuXG5pbnQgbWFpbihpbnQgYXJnYywgY2hhciAqKiBhcmd2KSB7XG4gICAgLy8gRXhlY3V0ZWQgd2l0aCBhcmdzIFwiYSBiIGMgZCBlXCIsIHNob3VsZCByZXR1cm4gMTIwIG5vcm1hbGx5XG4gICAgcmV0dXJuIGZhY3RvcmlhbChkZWNyZW1lbnQoYXJnYykpO1xufSJ9XX0=">clang_working</a></td><td style=text-align:left><a href=https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImNsYW5nMTQwMCIsIm9wdGlvbnMiOiIifV0sImV4ZWN1dG9ycyI6W3siYXJndW1lbnRzIjoiYSBiIGMgZCBlIiwiY29tcGlsZXIiOnsiaWQiOiJjbGFuZzE0MDAiLCJvcHRpb25zIjoiIn0sImNvbXBpbGVyT3V0cHV0VmlzaWJsZSI6InRydWUifV0sImlkIjoxLCJsYW5ndWFnZSI6ImMrKyIsInNvdXJjZSI6IiNpZiBkZWZpbmVkKF9fY2xhbmdfXylcbiNkZWZpbmUgRk9SQ0VfSU5MSU5FIFtbZ251OjphbHdheXNfaW5saW5lXV0gW1tnbnU6OmdudV9pbmxpbmVdXSBleHRlcm4gaW5saW5lXG4jZWxpZiBkZWZpbmVkKF9fR05VQ19fKVxuI2RlZmluZSBGT1JDRV9JTkxJTkUgW1tnbnU6OmFsd2F5c19pbmxpbmVdXSBpbmxpbmVcbiNlbGlmIGRlZmluZWQoX01TQ19WRVIpXG4jcHJhZ21hIHdhcm5pbmcoZXJyb3I6IDQ3MTQpXG4jZGVmaW5lIEZPUkNFX0lOTElORSBfX2ZvcmNlaW5saW5lXG4jZWxzZVxuI2Vycm9yIFVuc3VwcG9ydGVkIGNvbXBpbGVyXG4jZW5kaWZcblxuRk9SQ0VfSU5MSU5FIGludCBkZWNyZW1lbnQoaW50IHgpIHsgcmV0dXJuIHggLSAxOyB9XG5GT1JDRV9JTkxJTkUgaW50IGZhY3RvcmlhbChpbnQgeCkgeyByZXR1cm4gKHggPT0gMCkgPyAxIDogeCAqIGZhY3RvcmlhbCh4IC0gMSk7IH1cblxuaW50IG1haW4oaW50IGFyZ2MsIGNoYXIgKiogYXJndikge1xuICAgIC8vIEV4ZWN1dGVkIHdpdGggYXJncyBcImEgYiBjIGQgZVwiLCBzaG91bGQgcmV0dXJuIDEyMCBub3JtYWxseVxuICAgIHJldHVybiBmYWN0b3JpYWwoZGVjcmVtZW50KGFyZ2MpKTtcbn0ifV19>clang_error</a></td><td style=text-align:left>Linker error</td></tr><tr><td style=text-align:left>GCC</td><td style=text-align:left><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiIn1dLCJleGVjdXRvcnMiOlt7ImFyZ3VtZW50cyI6ImEgYiBjIGQgZSIsImNvbXBpbGVyIjp7ImlkIjoiZzEyMSIsIm9wdGlvbnMiOiIifSwiY29tcGlsZXJPdXRwdXRWaXNpYmxlIjoidHJ1ZSJ9XSwiaWQiOjEsImxhbmd1YWdlIjoiYysrIiwic291cmNlIjoiI2lmIGRlZmluZWQoX19jbGFuZ19fKVxuI2RlZmluZSBGT1JDRV9JTkxJTkUgW1tnbnU6OmFsd2F5c19pbmxpbmVdXSBbW2dudTo6Z251X2lubGluZV1dIGV4dGVybiBpbmxpbmVcbiNlbGlmIGRlZmluZWQoX19HTlVDX18pXG4jZGVmaW5lIEZPUkNFX0lOTElORSBbW2dudTo6YWx3YXlzX2lubGluZV1dIGlubGluZVxuI2VsaWYgZGVmaW5lZChfTVNDX1ZFUilcbiNwcmFnbWEgd2FybmluZyhlcnJvcjogNDcxNClcbiNkZWZpbmUgRk9SQ0VfSU5MSU5FIF9fZm9yY2VpbmxpbmVcbiNlbHNlXG4jZXJyb3IgVW5zdXBwb3J0ZWQgY29tcGlsZXJcbiNlbmRpZlxuXG5GT1JDRV9JTkxJTkUgaW50IGRlY3JlbWVudChpbnQgeCkgeyByZXR1cm4geCAtIDE7IH1cbmludCBmYWN0b3JpYWwoaW50IHgpIHsgcmV0dXJuICh4ID09IDApID8gMSA6IHggKiBmYWN0b3JpYWwoeCAtIDEpOyB9XG5cbmludCBtYWluKGludCBhcmdjLCBjaGFyICoqIGFyZ3YpIHtcbiAgICAvLyBFeGVjdXRlZCB3aXRoIGFyZ3MgXCJhIGIgYyBkIGVcIiwgc2hvdWxkIHJldHVybiAxMjAgbm9ybWFsbHlcbiAgICByZXR1cm4gZmFjdG9yaWFsKGRlY3JlbWVudChhcmdjKSk7XG59In1dfQ==">gcc_working</a></td><td style=text-align:left><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImcxMjEiLCJvcHRpb25zIjoiIn1dLCJleGVjdXRvcnMiOlt7ImFyZ3VtZW50cyI6ImEgYiBjIGQgZSIsImNvbXBpbGVyIjp7ImlkIjoiZzEyMSIsIm9wdGlvbnMiOiIifSwiY29tcGlsZXJPdXRwdXRWaXNpYmxlIjoidHJ1ZSJ9XSwiaWQiOjEsImxhbmd1YWdlIjoiYysrIiwic291cmNlIjoiI2lmIGRlZmluZWQoX19jbGFuZ19fKVxuI2RlZmluZSBGT1JDRV9JTkxJTkUgW1tnbnU6OmFsd2F5c19pbmxpbmVdXSBbW2dudTo6Z251X2lubGluZV1dIGV4dGVybiBpbmxpbmVcbiNlbGlmIGRlZmluZWQoX19HTlVDX18pXG4jZGVmaW5lIEZPUkNFX0lOTElORSBbW2dudTo6YWx3YXlzX2lubGluZV1dIGlubGluZVxuI2VsaWYgZGVmaW5lZChfTVNDX1ZFUilcbiNwcmFnbWEgd2FybmluZyhlcnJvcjogNDcxNClcbiNkZWZpbmUgRk9SQ0VfSU5MSU5FIF9fZm9yY2VpbmxpbmVcbiNlbHNlXG4jZXJyb3IgVW5zdXBwb3J0ZWQgY29tcGlsZXJcbiNlbmRpZlxuXG5GT1JDRV9JTkxJTkUgaW50IGRlY3JlbWVudChpbnQgeCkgeyByZXR1cm4geCAtIDE7IH1cbkZPUkNFX0lOTElORSBpbnQgZmFjdG9yaWFsKGludCB4KSB7IHJldHVybiAoeCA9PSAwKSA%2FIDEgOiB4ICogZmFjdG9yaWFsKHggLSAxKTsgfVxuXG5pbnQgbWFpbihpbnQgYXJnYywgY2hhciAqKiBhcmd2KSB7XG4gICAgLy8gRXhlY3V0ZWQgd2l0aCBhcmdzIFwiYSBiIGMgZCBlXCIsIHNob3VsZCByZXR1cm4gMTIwIG5vcm1hbGx5XG4gICAgcmV0dXJuIGZhY3RvcmlhbChkZWNyZW1lbnQoYXJnYykpO1xufSJ9XX0=">gcc_error</a></td><td style=text-align:left>Compile error</td></tr><tr><td style=text-align:left>MSVC</td><td style=text-align:left><a href=https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6InZjcHBfdjE5X2xhdGVzdF94NjQiLCJvcHRpb25zIjoiL09iMSJ9XSwiZXhlY3V0b3JzIjpbeyJhcmd1bWVudHMiOiJhIGIgYyBkIGUiLCJjb21waWxlciI6eyJpZCI6InZjcHBfdjE5X2xhdGVzdF94NjQiLCJvcHRpb25zIjoiL09iMSJ9LCJjb21waWxlck91dHB1dFZpc2libGUiOiJ0cnVlIn1dLCJpZCI6MSwibGFuZ3VhZ2UiOiJjKysiLCJzb3VyY2UiOiIjaWYgZGVmaW5lZChfX2NsYW5nX18pXG4jZGVmaW5lIEZPUkNFX0lOTElORSBbW2dudTo6YWx3YXlzX2lubGluZV1dIFtbZ251OjpnbnVfaW5saW5lXV0gZXh0ZXJuIGlubGluZVxuI2VsaWYgZGVmaW5lZChfX0dOVUNfXylcbiNkZWZpbmUgRk9SQ0VfSU5MSU5FIFtbZ251OjphbHdheXNfaW5saW5lXV0gaW5saW5lXG4jZWxpZiBkZWZpbmVkKF9NU0NfVkVSKVxuI3ByYWdtYSB3YXJuaW5nKGVycm9yOiA0NzE0KVxuI2RlZmluZSBGT1JDRV9JTkxJTkUgX19mb3JjZWlubGluZVxuI2Vsc2VcbiNlcnJvciBVbnN1cHBvcnRlZCBjb21waWxlclxuI2VuZGlmXG5cbkZPUkNFX0lOTElORSBpbnQgZGVjcmVtZW50KGludCB4KSB7IHJldHVybiB4IC0gMTsgfVxuaW50IGZhY3RvcmlhbChpbnQgeCkgeyByZXR1cm4gKHggPT0gMCkgPyAxIDogeCAqIGZhY3RvcmlhbCh4IC0gMSk7IH1cblxuaW50IG1haW4oaW50IGFyZ2MsIGNoYXIgKiogYXJndikge1xuICAgIC8vIEV4ZWN1dGVkIHdpdGggYXJncyBcImEgYiBjIGQgZVwiLCBzaG91bGQgcmV0dXJuIDEyMCBub3JtYWxseVxuICAgIHJldHVybiBmYWN0b3JpYWwoZGVjcmVtZW50KGFyZ2MpKTtcbn0ifV19>msvc_working</a></td><td style=text-align:left><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6InZjcHBfdjE5X2xhdGVzdF94NjQiLCJvcHRpb25zIjoiL09iMSJ9XSwiZXhlY3V0b3JzIjpbeyJhcmd1bWVudHMiOiJhIGIgYyBkIGUiLCJjb21waWxlciI6eyJpZCI6InZjcHBfdjE5X2xhdGVzdF94NjQiLCJvcHRpb25zIjoiL09iMSJ9LCJjb21waWxlck91dHB1dFZpc2libGUiOiJ0cnVlIn1dLCJpZCI6MSwibGFuZ3VhZ2UiOiJjKysiLCJzb3VyY2UiOiIjaWYgZGVmaW5lZChfX2NsYW5nX18pXG4jZGVmaW5lIEZPUkNFX0lOTElORSBbW2dudTo6YWx3YXlzX2lubGluZV1dIFtbZ251OjpnbnVfaW5saW5lXV0gZXh0ZXJuIGlubGluZVxuI2VsaWYgZGVmaW5lZChfX0dOVUNfXylcbiNkZWZpbmUgRk9SQ0VfSU5MSU5FIFtbZ251OjphbHdheXNfaW5saW5lXV0gaW5saW5lXG4jZWxpZiBkZWZpbmVkKF9NU0NfVkVSKVxuI3ByYWdtYSB3YXJuaW5nKGVycm9yOiA0NzE0KVxuI2RlZmluZSBGT1JDRV9JTkxJTkUgX19mb3JjZWlubGluZVxuI2Vsc2VcbiNlcnJvciBVbnN1cHBvcnRlZCBjb21waWxlclxuI2VuZGlmXG5cbkZPUkNFX0lOTElORSBpbnQgZGVjcmVtZW50KGludCB4KSB7IHJldHVybiB4IC0gMTsgfVxuRk9SQ0VfSU5MSU5FIGludCBmYWN0b3JpYWwoaW50IHgpIHsgcmV0dXJuICh4ID09IDApID8gMSA6IHggKiBmYWN0b3JpYWwoeCAtIDEpOyB9XG5cbmludCBtYWluKGludCBhcmdjLCBjaGFyICoqIGFyZ3YpIHtcbiAgICAvLyBFeGVjdXRlZCB3aXRoIGFyZ3MgXCJhIGIgYyBkIGVcIiwgc2hvdWxkIHJldHVybiAxMjAgbm9ybWFsbHlcbiAgICByZXR1cm4gZmFjdG9yaWFsKGRlY3JlbWVudChhcmdjKSk7XG59In1dfQ==">msvc_error</a></td><td style=text-align:left>Compile error (requires optimization flag)</td></tr></tbody></table><p>How it works:</p><ul><li>GCC would generate an error if it cant <code>always_inline</code> <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></li><li>Clang:<ul><li>Does not generate an error for non-inlinable <code>always_inline</code> functions. <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li><li>Instead <code>gnu_inline</code> and <code>extern inline</code> forces it to not generate any code for the function <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></li><li>Thus give a linker error if it is not inlined</li></ul></li><li>MSVC:<ul><li>Generates a warning for for non-inlinable <code>__forceinline</code> functions</li><li>But only if compiled with any &ldquo;inline expansion&rdquo; optimization (<code>/Ob&lt;n></code>) <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li><li>This is present with <code>/O1</code> or <code>/O2</code></li><li>We promote this warning to an error</li></ul></li></ul><p><strong>Note</strong>: do not use this with virtual functions. You can&rsquo;t &ldquo;force inline&rdquo; them as they need to be pointed to at runtime.</p><p>This thus allows us to build syntactic sugar as functions instead of weird macros. Without any worries of performance.</p><p>GCC summarizes this as &ldquo;An Inline Function is As Fast As a Macro&rdquo; <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p><p>Zig provides something similar as its <a href=https://ziglang.org/documentation/0.9.1/#Functions><code>callconv(.Inline)</code></a></p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://clang.llvm.org/docs/AttributeReference.html#always-inline-force-inline>https://clang.llvm.org/docs/AttributeReference.html#always-inline-force-inline</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://docs.microsoft.com/en-us/cpp/cpp/inline-functions-cpp>https://docs.microsoft.com/en-us/cpp/cpp/inline-functions-cpp</a> <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#always_inline>https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#always_inline</a> <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p><a href=https://clang.llvm.org/docs/AttributeReference.html#gnu-inline>https://clang.llvm.org/docs/AttributeReference.html#gnu-inline</a> <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p><a href=https://gcc.gnu.org/onlinedocs/gcc/Inline.html>https://gcc.gnu.org/onlinedocs/gcc/Inline.html</a> <a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><div class=tags></div></article><script src=https://utteranc.es/client.js repo=meghprkh/blog issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script></main><footer><p>&copy; 2022 <a href=http://meghprkh.github.io/blog/>Megh's Blog</a></p></footer><script src=../../js/theme.js></script></body></html>