<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>BTrait Introduction</title><link rel=stylesheet href=../../css/style.css></head><body><header class=site-header><h1>Megh's Blog</h1><nav><ul><li><a href=../../>Home</a></li><li><a href=../../categories>Categories</a></li><li><a href=../../tags>Tags</a></li><li><a href=../../about>About</a></li><li><a href=../../index.xml>Feed</a></li></ul></nav></header><main><article class=post><h1 class=title>BTrait Introduction</h1><div class=article-details><time>Mon Jul 25 2022</time>
in
<a href=../../categories/c++>C++</a></div><div><nav id=TableOfContents><ul><li><a href=#what-are-traits>What are traits</a></li><li><a href=#traits-use-cases-and-super-powers>Traits use-cases and super-powers</a><ul><li><a href=#code-reuse>Code reuse</a></li><li><a href=#method-dispatching>Method dispatching</a></li><li><a href=#trait-objects>Trait objects</a></li><li><a href=#composability>Composability</a></li><li><a href=#orphan-rule>Orphan rule</a></li><li><a href=#zero-cost-abstraction>Zero-cost abstraction</a></li></ul></li><li><a href=#comparisons>Comparisons</a><ul><li><a href=#c-inheritance-and-abstract-classes>C++ inheritance and abstract classes</a></li><li><a href=#c-concepts>C++ Concepts</a></li></ul></li></ul></nav><p><strong>THIS IS A DRAFT POST</strong></p><p>I love Rust. Rust&rsquo;s traits are powerful yet easy-to-use abstractions. C++ abstract classes and concepts are quite similar. C++ also has type traits and other traits like iterator traits. In this post I will introduce a simple Rust trait and implement this in C++. I will refer to this design pattern / header-library as BTrait.</p><p><em>Have I BTrayed Rust by implementing BTrait? Read on to find out more&mldr; drumrolls&mldr;</em> (Okay no more puns now)</p><h2 id=what-are-traits>What are traits</h2><p>Traits can be understood as a collection of methods, constants and associated types implemented for a class.</p><p>Lets define a trait called <code>Counter</code> in Rust</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>trait</span> Counter {
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_count</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>i64</span>; <span style=color:#75715e>// type will have a get_count method
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>set_count</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, new_count: <span style=color:#66d9ef>i64</span>); <span style=color:#75715e>// type will have a set_count
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>increment</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) { <span style=color:#75715e>// increment method which has a default implementation
</span><span style=color:#75715e></span>        self.set_count(self.get_count() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>);
    }

    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>max_count</span>() -&gt; <span style=color:#66d9ef>i64</span>; <span style=color:#75715e>// maxCount free function returns the maximum possible count
</span><span style=color:#75715e></span>}
</code></pre></div><p>Now lets implement that trait for <code>MyCounter</code> and use that trait</p><div class=code-play-button><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6InIxNjIwIiwib3B0aW9ucyI6IiJ9XSwiZXhlY3V0b3JzIjpbeyJjb21waWxlciI6eyJpZCI6InIxNjIwIiwib3B0aW9ucyI6IiJ9fV0sImlkIjoxLCJsYW5ndWFnZSI6InJ1c3QiLCJzb3VyY2UiOiJ0cmFpdCBDb3VudGVyIHtcbiAgICBmbiBnZXRfY291bnQoXHUwMDI2c2VsZikgLVx1MDAzZSBpNjQ7IC8vIHR5cGUgd2lsbCBoYXZlIGEgZ2V0X2NvdW50IG1ldGhvZFxuICAgIGZuIHNldF9jb3VudChcdTAwMjZtdXQgc2VsZiwgbmV3X2NvdW50OiBpNjQpOyAvLyB0eXBlIHdpbGwgaGF2ZSBhIHNldF9jb3VudFxuICAgIGZuIGluY3JlbWVudChcdTAwMjZtdXQgc2VsZikgeyAvLyBpbmNyZW1lbnQgbWV0aG9kIHdoaWNoIGhhcyBhIGRlZmF1bHQgaW1wbGVtZW50YXRpb25cbiAgICAgICAgc2VsZi5zZXRfY291bnQoc2VsZi5nZXRfY291bnQoKSArIDEpO1xuICAgIH1cblxuICAgIGZuIG1heF9jb3VudCgpIC1cdTAwM2UgaTY0OyAvLyBtYXhDb3VudCBmcmVlIGZ1bmN0aW9uIHJldHVybnMgdGhlIG1heGltdW0gcG9zc2libGUgY291bnRcbn1cblxuc3RydWN0IE15Q291bnRlciB7XG4gICAgY291bnQ6IGk2NFxufVxuXG5pbXBsIENvdW50ZXIgZm9yIE15Q291bnRlciB7XG4gICAgZm4gZ2V0X2NvdW50KFx1MDAyNnNlbGYpIC1cdTAwM2UgaTY0IHsgcmV0dXJuIHNlbGYuY291bnQ7IH1cbiAgICBmbiBzZXRfY291bnQoXHUwMDI2bXV0IHNlbGYsIG5ld19jb3VudDogaTY0KSB7IHNlbGYuY291bnQgPSBuZXdfY291bnQ7IH1cblxuICAgIGZuIG1heF9jb3VudCgpIC1cdTAwM2UgaTY0IHsgcmV0dXJuIDEwMDsgfVxufVxuXG5mbiBtYWluKCkge1xuICAgIGxldCBtdXQgY291bnRlciA9IE15Q291bnRlciB7IGNvdW50OiAyNSB9O1xuICAgIHByaW50bG4hKFwie31cIiwgY291bnRlci5nZXRfY291bnQoKSk7IC8vIDI1XG4gICAgY291bnRlci5zZXRfY291bnQoMTApO1xuICAgIC8vIGNvdW50ZXIuZ2V0X2NvdW50IGlzIHN5bnRhY3RpYyBzdWdhciBmb3JcbiAgICBwcmludGxuIShcInt9XCIsIENvdW50ZXI6OmdldF9jb3VudChcdTAwMjZjb3VudGVyKSk7IC8vIDEwXG4gICAgY291bnRlci5pbmNyZW1lbnQoKTsgLy8gd2lsbCB1c2UgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBpbmNyZW1lbnRcbiAgICBwcmludGxuIShcInt9XCIsIGNvdW50ZXIuZ2V0X2NvdW50KCkpOyAvLyAxMVxuICAgIHByaW50bG4hKFwie31cIiwgTXlDb3VudGVyOjptYXhfY291bnQoKSk7IC8vIDEwMFxufSJ9XX0=">&#9654;</a></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MyCounter</span> {
    count: <span style=color:#66d9ef>i64</span>
}

<span style=color:#66d9ef>impl</span> Counter <span style=color:#66d9ef>for</span> MyCounter {
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_count</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>i64</span> { <span style=color:#66d9ef>return</span> self.count; }
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>set_count</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, new_count: <span style=color:#66d9ef>i64</span>) { self.count <span style=color:#f92672>=</span> new_count; }

    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>max_count</span>() -&gt; <span style=color:#66d9ef>i64</span> { <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>100</span>; }
}

<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> counter <span style=color:#f92672>=</span> MyCounter { count: <span style=color:#ae81ff>25</span> };
    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, counter.get_count()); <span style=color:#75715e>// 25
</span><span style=color:#75715e></span>    counter.set_count(<span style=color:#ae81ff>10</span>);
    <span style=color:#75715e>// counter.get_count is syntactic sugar for
</span><span style=color:#75715e></span>    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, Counter::get_count(<span style=color:#f92672>&amp;</span>counter)); <span style=color:#75715e>// 10
</span><span style=color:#75715e></span>    counter.increment(); <span style=color:#75715e>// will use default implementation of increment
</span><span style=color:#75715e></span>    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, counter.get_count()); <span style=color:#75715e>// 11
</span><span style=color:#75715e></span>    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, MyCounter::max_count()); <span style=color:#75715e>// 100
</span><span style=color:#75715e></span>}
</code></pre></div><p>Now for example the trait could have had an <em>associated constant</em> called <code>STEP</code> and <code>increment</code> could have used that</p><div class=code-play-button><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6InIxNjIwIiwib3B0aW9ucyI6IiJ9XSwiZXhlY3V0b3JzIjpbeyJjb21waWxlciI6eyJpZCI6InIxNjIwIiwib3B0aW9ucyI6IiJ9fV0sImlkIjoxLCJsYW5ndWFnZSI6InJ1c3QiLCJzb3VyY2UiOiJ0cmFpdCBDb3VudGVyIHtcbiAgICBmbiBnZXRfY291bnQoXHUwMDI2c2VsZikgLVx1MDAzZSBpNjQ7IC8vIHR5cGUgd2lsbCBoYXZlIGEgZ2V0X2NvdW50IG1ldGhvZFxuICAgIGZuIHNldF9jb3VudChcdTAwMjZtdXQgc2VsZiwgbmV3X2NvdW50OiBpNjQpOyAvLyB0eXBlIHdpbGwgaGF2ZSBhIHNldF9jb3VudFxuXG4gICAgY29uc3QgU1RFUDogaTY0OyAvLyBGb3IgYSBkZWZhdWx0IHZhbHVlLCBjYW4gd3JpdGU6IGNvbnN0IFNURVA6IGk2NCA9IDFcbiAgICBmbiBpbmNyZW1lbnQoXHUwMDI2bXV0IHNlbGYpIHsgLy8gaW5jcmVtZW50IG1ldGhvZCBzaG91bGQgaW5jcmVtZW50IGJ5IFNURVBcbiAgICAgICAgc2VsZi5zZXRfY291bnQoc2VsZi5nZXRfY291bnQoKSArIFNlbGY6OlNURVApO1xuICAgIH1cblxuICAgIGZuIG1heF9jb3VudCgpIC1cdTAwM2UgaTY0OyAvLyBtYXhDb3VudCBmcmVlIGZ1bmN0aW9uIHJldHVybnMgdGhlIG1heGltdW0gcG9zc2libGUgY291bnRcbn1cblxuc3RydWN0IE15Q291bnRlciB7XG4gICAgY291bnQ6IGk2NFxufVxuXG5pbXBsIENvdW50ZXIgZm9yIE15Q291bnRlciB7XG4gICAgY29uc3QgU1RFUDogaTY0ID0gMjsgLy8gaW5jcmVtZW50IGJ5IDJcblxuICAgIGZuIGdldF9jb3VudChcdTAwMjZzZWxmKSAtXHUwMDNlIGk2NCB7IHJldHVybiBzZWxmLmNvdW50OyB9XG4gICAgZm4gc2V0X2NvdW50KFx1MDAyNm11dCBzZWxmLCBuZXdfY291bnQ6IGk2NCkgeyBzZWxmLmNvdW50ID0gbmV3X2NvdW50OyB9XG5cbiAgICBmbiBtYXhfY291bnQoKSAtXHUwMDNlIGk2NCB7IHJldHVybiAxMDA7IH1cbn1cblxuZm4gbWFpbigpIHtcbiAgICBsZXQgbXV0IGNvdW50ZXIgPSBNeUNvdW50ZXIgeyBjb3VudDogMjUgfTtcbiAgICBjb3VudGVyLmluY3JlbWVudCgpOyAvLyAyNyAoID0gY291bnQgMjUgKyBTVEVQIDIgKVxuICAgIHByaW50bG4hKFwie31cIiwgY291bnRlci5nZXRfY291bnQoKSk7IC8vIDI3XG59In1dfQ==">&#9654;</a></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>trait</span> Counter {
    <span style=color:#66d9ef>const</span> STEP: <span style=color:#66d9ef>i64</span>; <span style=color:#75715e>// For a default value, can write: const STEP: i64 = 1
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>increment</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) { <span style=color:#75715e>// increment method should increment by STEP
</span><span style=color:#75715e></span>        self.set_count(self.get_count() <span style=color:#f92672>+</span> Self::STEP);
    }
}
<span style=color:#66d9ef>impl</span> Counter <span style=color:#66d9ef>for</span> MyCounter {
    <span style=color:#66d9ef>const</span> STEP: <span style=color:#66d9ef>i64</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>; <span style=color:#75715e>// increment by 2
</span><span style=color:#75715e></span>}

<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> counter <span style=color:#f92672>=</span> MyCounter { count: <span style=color:#ae81ff>25</span> };
    counter.increment(); <span style=color:#75715e>// 27 ( = count 25 + STEP 2 )
</span><span style=color:#75715e></span>    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, counter.get_count()); <span style=color:#75715e>// 27
</span><span style=color:#75715e></span>}
</code></pre></div><p>It could also have had an <em>associated type</em> which represented the type of the count, for example <code>u32</code> or <code>i64</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>trait</span> Counter {
    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CountType</span>;
    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_count</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>CountType</span> { <span style=color:#66d9ef>return</span> self.count; }
}
<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MyCounter</span> {
    count: <span style=color:#66d9ef>i64</span>;
}
<span style=color:#66d9ef>impl</span> Counter <span style=color:#66d9ef>for</span> MyCounter {
    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CountType</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>i64</span>;
}
</code></pre></div><h2 id=traits-use-cases-and-super-powers>Traits use-cases and super-powers</h2><h3 id=code-reuse>Code reuse</h3><p>Traits thus allow us to specify default methods/values encouraging code-reuse and not having to write everything for every type.</p><h3 id=method-dispatching>Method dispatching</h3><p>Method dispatching can also be controlled via traits. C++ developers will immediately recognize this as SFINAE.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_counter</span>(count: <span style=color:#a6e22e>impl</span> Counter) {
    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, count.getCount());
}
<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_counter</span>(count: <span style=color:#66d9ef>i64</span>) {
    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;i64 count {}&#34;</span>, count);
}
print_counter(mycounter); <span style=color:#75715e>// works
</span><span style=color:#75715e></span>print_counter(<span style=color:#ae81ff>32</span>); <span style=color:#75715e>// calls i64 count
</span><span style=color:#75715e></span>print_counter(some_other_type); <span style=color:#75715e>// compile error
</span></code></pre></div><h3 id=trait-objects>Trait objects</h3><p>You can also store &ldquo;trait objects&rdquo; or pointers to them. This is extremely useful in say a GUI library that stores widgets of different types unkown at compile time. Also, in the previous example a copy of the <code>print_counter</code> function would be generated for every type that implements <code>Counter</code>. This gives great performance but increases compilation times.</p><div class=code-play-button><a href="https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6InIxNjIwIiwib3B0aW9ucyI6IiJ9XSwiZXhlY3V0b3JzIjpbeyJjb21waWxlciI6eyJpZCI6InIxNjIwIiwib3B0aW9ucyI6IiJ9fV0sImlkIjoxLCJsYW5ndWFnZSI6InJ1c3QiLCJzb3VyY2UiOiJ0cmFpdCBDb3VudGVyIHtcbiAgICBmbiBnZXRfY291bnQoXHUwMDI2c2VsZikgLVx1MDAzZSBpNjQ7IC8vIHR5cGUgd2lsbCBoYXZlIGEgZ2V0X2NvdW50IG1ldGhvZFxufVxuXG5zdHJ1Y3QgTXlDb3VudGVyIHtcbiAgICBjb3VudDogaTY0XG59XG5pbXBsIENvdW50ZXIgZm9yIE15Q291bnRlciB7XG4gICAgZm4gZ2V0X2NvdW50KFx1MDAyNnNlbGYpIC1cdTAwM2UgaTY0IHsgcmV0dXJuIHNlbGYuY291bnQ7IH1cbn1cblxuc3RydWN0IEFub3RoZXJDb3VudGVyIHtcbiAgICBjdXRlX2NvdW50OiBpNjRcbn1cbmltcGwgQ291bnRlciBmb3IgQW5vdGhlckNvdW50ZXIge1xuICAgIGZuIGdldF9jb3VudChcdTAwMjZzZWxmKSAtXHUwMDNlIGk2NCB7IHJldHVybiBzZWxmLmN1dGVfY291bnQ7IH1cbn1cblxuLy8gQm94XHUwMDNjZHluIENvdW50ZXJcdTAwM2UgY2FuIGJlIGFueSB0eXBlIGFuZCBpcyByZXNvbHZlZCBhdCBydW50aW1lXG4vLyBUaGUgZnVuY3Rpb24gaXMgbm90IFwiY29weS1wYXN0ZWRcIiBmb3IgYWxsIHR5cGVzIHRoYXQgaW1wbGVtZW50IENvdW50ZXJcbmZuIHByaW50X2NvdW50ZXIoY291bnQ6IEJveFx1MDAzY2R5biBDb3VudGVyXHUwMDNlKSB7XG4gICAgcHJpbnRsbiEoXCJ7fVwiLCBjb3VudC5nZXRfY291bnQoKSk7XG59XG5cbmZuIG1haW4oKSB7XG4gICAgbGV0IGNvdW50ZXIxID0gTXlDb3VudGVyIHsgY291bnQ6IDI1IH07XG4gICAgbGV0IGNvdW50ZXIyID0gQW5vdGhlckNvdW50ZXIgeyBjdXRlX2NvdW50OiAzMiB9O1xuICAgIC8vIFwiQm94ZXNcIiBvZiBkaWZmZXJlbnQgdHlwZXMgdGhhdCBpbXBsZW1lbnQgQ291bnRlciBjYW4gYWxzbyBiZSBzdG9yZWRcbiAgICAvLyBpbiB0aGUgc2FtZSBjb250YWluZXIuIE5vcm1hbGx5IHlvdSBjYW50IHN0b3JlIGRpZmZlcmVudCB0eXBlcyBpbiBhIHZlY3Rvci5cbiAgICAvLyAoQSBCb3ggaXMganVzdCBhIHNtYXJ0IHBvaW50ZXIgLSB1bmlxdWVfcG9pbnRlciBpbiBDKysgdGVybWlub2xvZ3kpXG4gICAgbGV0IG11dCBhbGxfY291bnRlcnM6IFZlY1x1MDAzY0JveFx1MDAzY2R5biBDb3VudGVyXHUwMDNlXHUwMDNlID0gdmVjIVtdO1xuICAgIGFsbF9jb3VudGVycy5wdXNoKEJveDo6ZnJvbShjb3VudGVyMSkpO1xuICAgIGFsbF9jb3VudGVycy5wdXNoKEJveDo6ZnJvbShjb3VudGVyMikpO1xuICAgIGZvciBjb3VudGVyIGluIGFsbF9jb3VudGVycyB7XG4gICAgICAgIHByaW50X2NvdW50ZXIoQm94Ojpmcm9tKGNvdW50ZXIpKTtcbiAgICB9XG59In1dfQ==">&#9654;</a></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=color:#75715e>// Box&lt;dyn Counter&gt; can be any type and is resolved at runtime
</span><span style=color:#75715e>// The function is not &#34;copy-pasted&#34; for all types that implement Counter
</span><span style=color:#75715e></span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>print_counter</span>(count: Box<span style=color:#f92672>&lt;</span>dyn Counter<span style=color:#f92672>&gt;</span>) {
    println<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;{}&#34;</span>, count.get_count());
}

<span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#66d9ef>let</span> counter1 <span style=color:#f92672>=</span> MyCounter { count: <span style=color:#ae81ff>25</span> };
    <span style=color:#66d9ef>let</span> counter2 <span style=color:#f92672>=</span> AnotherCounter { cute_count: <span style=color:#ae81ff>32</span> };
    <span style=color:#75715e>// &#34;Boxes&#34; of different types that implement Counter can also be stored
</span><span style=color:#75715e></span>    <span style=color:#75715e>// in the same container. Normally you cant store different types in a vector.
</span><span style=color:#75715e></span>    <span style=color:#75715e>// (A Box is just a smart pointer - unique_pointer in C++ terminology)
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> all_counters: Vec<span style=color:#f92672>&lt;</span>Box<span style=color:#f92672>&lt;</span>dyn Counter<span style=color:#f92672>&gt;&gt;</span> <span style=color:#f92672>=</span> vec<span style=color:#f92672>!</span>[];
    all_counters.push(Box::from(counter1));
    all_counters.push(Box::from(counter2));
    <span style=color:#66d9ef>for</span> counter <span style=color:#66d9ef>in</span> all_counters {
        print_counter(Box::from(counter));
    }
}
</code></pre></div><h3 id=composability>Composability</h3><p>Both dispatching and trait objects can specify that multiple traits must be satisfied, for example <code>impl Counter + Serializable</code> or <code>dyn Couter + Serializable</code> can be used for a method like <code>snapshot_counter</code></p><p>Super traits can also be defined, for example <code>SnapshottableCounter</code> which requires that type implement both <code>Counter</code> and <code>Serializable</code> and provides a `snapshot method.</p><h3 id=orphan-rule>Orphan rule</h3><p>Rust allows defining a trait if we own the class or the trait. Note we can implement a trait <em>even if we do NOT own the class</em>. This comes in very handy.</p><p>For example, we want to write a recursive <code>toJson</code> method in a <code>JsonSerializable</code> trait. We realize that deep within our code we are storing a <code>vector&lt;int></code> directly and thus need to implement <code>JsonSerializable</code> for <code>vector&lt;int></code> which is a type we do not own. Such issues keep coming up when we want to define a &ldquo;custom trait&rdquo; but the class authors never anticipated it.</p><h3 id=zero-cost-abstraction>Zero-cost abstraction</h3><p>Traits do not add anything to the struct. <code>dyn</code> requires a vtable, but it is only added when a <code>dyn</code> is created.</p><h2 id=comparisons>Comparisons</h2><h3 id=c-inheritance-and-abstract-classes>C++ inheritance and abstract classes</h3><p>C++ allows inheritance, providing us something like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Counter</span> {
    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_count</span>() <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_count</span>(<span style=color:#66d9ef>int</span> new_count) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>increment</span>() { set_count(get_count() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>); }
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>max_count</span>() <span style=color:#f92672>=</span> <span style=color:#66d9ef>delete</span>;
};

<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MyCounter</span><span style=color:#f92672>:</span> Counter {
    <span style=color:#66d9ef>int</span> count;
    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>get_count</span>() <span style=color:#66d9ef>override</span> { <span style=color:#66d9ef>return</span> count; }
    <span style=color:#66d9ef>virtual</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_count</span>(<span style=color:#66d9ef>int</span> new_count) <span style=color:#66d9ef>override</span> { count <span style=color:#f92672>=</span> new_count; }
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>max_count</span>() { <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>100</span>; }
};
</code></pre></div><p><code>= 0</code> and <code>= delete</code> ensure that we must override the method in any inherited class.</p><p>The problem with this is inheritance adds a <code>vtable</code> to the struct. <code>sizeof(MyCounter) != sizeof(int)</code> anymore, even though <code>MyCounter</code> only stores an integer. Even more problems happen when we do multiple inheritance.</p><p>A vtable is essentially a table containing a method name to a pointer. For example in the vtable of <code>mycounter</code>, <code>set_count</code> will point to <code>MyCounter::set_count</code>, but <code>increment</code> will point to <code>Counter::increment</code>.</p><div class=code-play-button><a href=https://godbolt.org/clientstate/eyJzZXNzaW9ucyI6W3siY29tcGlsZXJzIjpbeyJpZCI6ImcxMjEiLCJvcHRpb25zIjpudWxsfV0sImV4ZWN1dG9ycyI6W3siY29tcGlsZXIiOnsiaWQiOiJnMTIxIiwib3B0aW9ucyI6bnVsbH19XSwiaWQiOjEsImxhbmd1YWdlIjoiYysrIiwic291cmNlIjoiI2luY2x1ZGUgXHUwMDNjaW9zdHJlYW1cdTAwM2VcbiNpbmNsdWRlIFx1MDAzY3R5cGVfdHJhaXRzXHUwMDNlXG5cbnN0cnVjdCBDb3VudGVyIHtcbiAgICB2aXJ0dWFsIGludCBnZXRfY291bnQoKSA9IDA7XG4gICAgdmlydHVhbCB2b2lkIHNldF9jb3VudChpbnQgbmV3X2NvdW50KSA9IDA7XG4gICAgdmlydHVhbCB2b2lkIGluY3JlbWVudCgpIHsgc2V0X2NvdW50KGdldF9jb3VudCgpICsgMSk7IH1cbiAgICBzdGF0aWMgaW50IG1heF9jb3VudCgpID0gZGVsZXRlO1xufTtcblxuc3RydWN0IE15Q291bnRlcjogQ291bnRlciB7XG4gICAgaW50IGNvdW50O1xuICAgIHZpcnR1YWwgaW50IGdldF9jb3VudCgpIG92ZXJyaWRlIHsgcmV0dXJuIGNvdW50OyB9XG4gICAgdmlydHVhbCB2b2lkIHNldF9jb3VudChpbnQgbmV3X2NvdW50KSBvdmVycmlkZSB7IGNvdW50ID0gbmV3X2NvdW50OyB9XG4gICAgc3RhdGljIGludCBtYXhfY291bnQoKSB7IHJldHVybiAxMDA7IH1cbn07XG5cbi8vIGNvbXBpbGUtdGltZVxudGVtcGxhdGUgXHUwMDNjdHlwZW5hbWUgVFx1MDAzZVxuc3RkOjplbmFibGVfaWZfdFx1MDAzYyBzdGQ6OmlzX2Jhc2Vfb2Zfdlx1MDAzY0NvdW50ZXIsIFRcdTAwM2UgLCB2b2lkXHUwMDNlXG5wcmludF9jb3VudGVyKFQgY291bnRlcikge1xuICAgIHN0ZDo6Y291dCBcdTAwM2NcdTAwM2MgY291bnRlci5nZXRfY291bnQoKSBcdTAwM2NcdTAwM2Mgc3RkOjplbmRsXG59XG5cbi8vIHJ1bnRpbWVcbnZvaWQgcHJpbnRfY291bnRlcihDb3VudGVyXHUwMDI2IGNvdW50ZXIpIHtcbiAgICAvLyBnZXRfY291bnQgd2lsbCBiZSBsb29rZWQgdXAgaW4gdnRhYmxlXG4gICAgc3RkOjpjb3V0IFx1MDAzY1x1MDAzYyBjb3VudGVyLmdldF9jb3VudCgpIFx1MDAzY1x1MDAzYyBzdGQ6OmVuZGxcbn1cblxuLy8gY2FuIGFsc28gc3RvcmUgVmVjdG9yXHUwMDNjQ291bnRlcipcdTAwM2VcbmludCBtYWluKCkge1xuICAgIE15Q291bnRlciBteWNvdW50ZXIgeyAyNSB9O1xuICAgIHByaW50X2NvdW50ZXIobXljb3VudGVyKTtcbiAgICBzdGQ6OmNvdXQgXHUwMDNjXHUwMDNjIE15Q291bnRlcjo6bWF4X2NvdW50KCkgXHUwMDNjXHUwMDNjIHN0ZDo6ZW5kbDtcbn0ifV19>&#9654;</a></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>// compile-time
</span><span style=color:#75715e></span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> T<span style=color:#f92672>&gt;</span>
std<span style=color:#f92672>::</span>enable_if_t<span style=color:#f92672>&lt;</span> std<span style=color:#f92672>::</span>is_base_of_v<span style=color:#f92672>&lt;</span>Counter, T<span style=color:#f92672>&gt;</span> , <span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span>
print_counter(T counter) {
    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> counter.get_count() <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl
}

<span style=color:#75715e>// runtime
</span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>print_counter</span>(Counter<span style=color:#f92672>&amp;</span> counter) {
    <span style=color:#75715e>// get_count will be looked up in vtable
</span><span style=color:#75715e></span>    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> counter.get_count() <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl
}

<span style=color:#75715e>// can also store Vector&lt;Counter*&gt;
</span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
    MyCounter mycounter { <span style=color:#ae81ff>25</span> };
    print_counter(mycounter);
    std<span style=color:#f92672>::</span>cout <span style=color:#f92672>&lt;&lt;</span> MyCounter<span style=color:#f92672>::</span>max_count() <span style=color:#f92672>&lt;&lt;</span> std<span style=color:#f92672>::</span>endl;
}
</code></pre></div><p>Thus inheritance provides us with</p><ul><li><input checked disabled type=checkbox> Code reuse</li><li><input checked disabled type=checkbox> Method dispatch</li><li><input checked disabled type=checkbox> Trait objects</li><li><input checked disabled type=checkbox> Composabiltiy - multiple inheritance exists</li><li><input disabled type=checkbox> Orphan rule - can only define</li><li><input disabled type=checkbox> Zero cost abstraction - adds vtables</li></ul><h3 id=c-concepts>C++ Concepts</h3><p>Concepts are primaril syntactic sugar that allow &ldquo;better SFINAE&rdquo;</p><p>There is no concept of &ldquo;trait objects&rdquo; or &ldquo;concept objects&rdquo;</p><p>TODO</p></div><div class=tags>[ Tags:
<a href=../../tags/c++>#C++</a>
<a href=../../tags/rust>#Rust</a>
<a href=../../tags/series-btrait-intro>#series-btrait-intro</a>
]</div></article><script src=https://utteranc.es/client.js repo=meghprkh/blog issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script></main><footer><p>&copy; 2022 <a href=http://meghprkh.github.io/blog/>Megh's Blog</a></p></footer></body></html>